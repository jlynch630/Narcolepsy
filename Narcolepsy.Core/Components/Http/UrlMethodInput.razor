@inherits ContextSensitiveComponent<IHttpRequestContext>
@using System.Text.RegularExpressions;
<div class="url-method-container">
    <select class="method-select" @bind="Context.Method.Value">
        @foreach (string Method in Configuration.AvailableHttpMethods) {
            <option value="@Method">@Method</option>
        }
    </select>
    <input class="url-input" type="text" value="@Context.Url.Value" @onchange="UrlChanged"/>
    <Button class="execute" @onclick="Execute">
        @if (!IsLoadingRequest) {
            <span>Send</span>
        }
        else {
            <Spinner />
        }
    </Button>
</div>

@code {
    [Parameter]
    public HttpViewConfiguration Configuration { get; set; }

    private bool IsLoadingRequest = false;

    private CancellationTokenSource ReqCancelToken;

    protected override void OnInitialized() {
        base.OnInitialized();
        this.UpdateOnChange(ctx => ctx.Url);
        this.UpdateOnChange(ctx => ctx.Method);
    }

    private async Task Execute() {
        if (this.IsLoadingRequest) {
            // cancel it!
            this.ReqCancelToken.Cancel();
            return;
        }

        this.ReqCancelToken = new CancellationTokenSource();
        this.IsLoadingRequest = true;
        this.StateHasChanged();
        await this.Context.Execute(this.ReqCancelToken.Token);
        this.IsLoadingRequest = false;
    }

    private async Task UrlChanged(ChangeEventArgs e) {
        string NewUrl = e.Value?.ToString() ?? "";

        if (!Regex.IsMatch(NewUrl, "^[A-Za-z\\-]+://"))
            NewUrl = "https://" + NewUrl;

        Context.Url.Value = NewUrl;
    }
}